

# HTTP/2

- 使用应用层协议协商（ALPN）（TLS的扩展，允许应用层在安全连接上实行哪个协议，以避免额外的往返协商通信）一边客户端从HTTP/1.0 HTTP/1.1 HTTP/2等协议中做出选择
- 在请求方法、状态码、和URI方面和绝大多数头部保持高度兼容性
- 通过以下举措减少网络延迟
  - 对HTTP头部字段进行数据压缩
  - 服务器推送
  - 将请求流水线化
  - 修复HTTP/1.x的对头阻塞问题（第一个数据包受阻导致整列数据包受阻）
  - 对数据传输采用多路复用，让多个请求合并在同一个TCP连接内

## 帧和二进制编码

HTTP2使用二进制消息分帧对消息进行高效的处理

HTTP/2的核心在于新的二进制分帧层

![HTTP/2 二进制分帧层](https://developers.google.com/web/fundamentals/performance/http2/images/binary_framing_layer01.svg?hl=zh-cn)

由图可知：HTTP消息的首部和内容被分别封装成首部帧（header frame）数据帧（data frame），从而形成一个二进制分帧层。该层是socket和应用的高级HTTP接口之间的一个经过优化的编码机制，HTTP的语义、动词、方法、首部都不受影响。不同的是编码机制：HTTP/1.x以换行符为纯文本分隔，而HTTP/2将传输的信息分割为更小的消息和帧，使用二进制格式进行编码

## 数据流、消息、帧

新的二进制分帧机制改变了客户端和服务器之间交换数据的方式

- 数据流（stream）：已建立连接内的双向数据流，可以承载一条或多条消息
- 消息（message）：与逻辑请求或响应相对应的一系列帧
- 帧：HTTP/2 通信最小单位，每个帧包含帧头，至少标识出当前帧所属的数据流

它们有如下关系：

- 所有通信都在一个 TCP 连接上完成，此连接可以承载任意数量的双向数据流。
- 每个数据流都有**一个唯一的标识符和可选的优先级信息**，用于承载双向消息。
- 每条消息都是一条逻辑 HTTP 消息（例如请求或响应），包含一个或多个帧。
- 帧是最小的通信单位，承载着特定类型的数据，例如 HTTP 标头、消息负载等等。 **来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装。**

![HTTP/2 数据流、消息和帧](https://developers.google.com/web/fundamentals/performance/http2/images/streams_messages_frames01.svg?hl=zh-cn)

## 请求与响应复用

在HTTP/1.X 中客户端要发起多个并行连接，则需要使用多个TCP连接，每个连接每次只交付一个响应，这种连接导致队首阻塞。而HTTP/2的二进制分帧层突破限制实现完整的请求复用和响应复用（客户端和服务器可以将请求、响应分解为互不依赖的帧，然后交错发送，最后在另一端组合起来）

将 HTTP 消息分解为独立的帧，交错发送，然后在另一端重新组装是 HTTP 2 最重要的一项增强，这可以：

![HTTP/2 request and response multiplexing within a shared connection](https://developers.google.com/web/fundamentals/performance/http2/images/multiplexing01.svg)

- 并行交错地发送多个请求，请求之间互不影响。
- 并行交错地发送多个响应，响应之间互不干扰。
- 使用一个连接并行发送多个请求和响应。
- 解决了队首阻塞的问题
- 消除不必要的延迟和提高现有网络容量的利用率，从而减少页面加载时间。

> 队首阻塞：在[计算机网络](https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C)的范畴中是一种性能受限的现象。它的原因是一列的第一个数据包（队头）受阻而导致整列数据包受阻。例如它有可能在缓存式输入的交换机中出现，有可能因为传输顺序错乱而出现，亦有可能在HTTP流水线中有多个请求的情况下出现。
>
> 在HTTP/1.x中，如果一个TCP连接上的一次HTTP事务没有完成，其他HTTP事务在持久化TCP连接的情况下也无法使用该TCP连接，必须等待队首的HTTP事务完成



### 数据流优先级

HTTP/2允许每个数据流都有一个关联的权重和依赖关系：

- 每个数据流分配一个1~256之间的整数
- 每个数据流与其他数据流之间存在显式依赖关系

数据流依赖关系和权重的组合让客户端可以构建和传递“优先级树”，表明它倾向于如何接收响应。 反过来，服务器可以使用此信息通过控制 CPU、内存和其他资源的分配设定数据流处理的优先级，在资源数据可用之后，带宽分配可以确保将高优先级响应以最优方式传输至客户端。

HTTP/2将另一个数据流唯一标识符作为父项引用进行声明，如果忽略标识符，响应数据流将依赖于跟数据流。声明数据流依赖指出，应尽先向父数据流分配资源。

共享相同父项的数据流（即，同级数据流）应按其权重比例分配资源。 例如，如果数据流 A 的权重为 12，其同级数据流 B 的权重为 4，那么要确定每个数据流应接收的资源比例，请执行以下操作：

1. 将所有权重求和：`4 + 12 = 16`
2. 将每个数据流权重除以总权重：`A = 12/16, B = 4/16`



有了分帧机制后，所有 HTTP/2 连接都是永久的，而且仅需要每个来源一个连接，随之带来诸多性能优势。



## 流控制

流控制是一种阻止发送方向接收方发送大量数据的机制，以免超出后者的需求或处理能力：发送方可能非常繁忙、处于较高的负载之下，也可能仅仅希望为特定数据流分配固定量的资源。 例如，客户端可能请求了一个具有较高优先级的大型视频流，但是用户已经暂停视频，客户端现在希望暂停或限制从服务器的传输，以免提取和缓冲不必要的数据。 再比如，一个代理服务器可能具有较快的下游连接和较慢的上游连接，并且也希望调节下游连接传输数据的速度以匹配上游连接的速度来控制其资源利用率；等等。

- 流控制具有方向性。 每个接收方都可以根据自身需要选择为每个数据流和整个连接设置任意的窗口大小。
- 流控制基于信用。 每个接收方都可以公布其初始连接和数据流流控制窗口（以字节为单位），每当发送方发出 `DATA` 帧时都会减小，在接收方发出 `WINDOW_UPDATE` 帧时增大。
- 流控制无法停用。 建立 HTTP/2 连接后，客户端将与服务器交换 `SETTINGS` 帧，这会在两个方向上设置流控制窗口。 流控制窗口的默认值设为 65,535 字节，但是接收方可以设置一个较大的最大窗口大小（`2^31-1` 字节），并在接收到任意数据时通过发送 `WINDOW_UPDATE` 帧来维持这一大小。
- 流控制为逐跃点控制，而非端到端控制。 即，可信中介可以使用它来控制资源使用，以及基于自身条件和启发式算法实现资源分配机制。



## 服务器推送

HTTP/2 另一个强大的功能是，服务器可以对一个客户端请求发送多个响应，就是说，除了最初请求的响应，还可以推送额外的资源。

因为一个网络应用包含多种资源，我们可以不必让客户端检查服务器提供的html文档才再次请求。我们知道客户端会需要哪些资源，这时候就可以使用服务器推送。

服务器推送数据流由PUSH_PROMISE帧发起，表明服务器要推送所描述资源的意图，该帧先于服务器请求推送资源的响应数据（need to be delivered ahead of the response data that requests the pushed resources. ）

